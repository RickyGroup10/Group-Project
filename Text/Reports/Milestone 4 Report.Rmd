---
title: "Exploratory Data Analysis"
author: "Lissa Harrop, Katrina Watkins, Ricky Loo and Max Tan"
date: "September 2022"
classoption: 12pt
  
header-includes:
  - \usepackage{newpxtext,eulerpx}
  - \usepackage{bm,bbm}

output: bookdown::pdf_document2

link-citations: yes
bibliography: references.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(300521444, kind="Mersenne-Twister") #Mixture of all our ID numbers
require(ggplot2)
require(ggthemes)
require(extrafont)
require(booktabs)
require(GGally)
require(ggExtra)
require(xtable)
require(moments)
require(ggcorrplot)
require(fitdistrplus)
require(reshape2)
#require(farff)
require(ggpubr)
require(dplyr)
```

# Exploratory Data Analysis of our overall data

# Univariate

We (group 10) decided to use the Dating App User Profiles' stats data set. The data set is available on kaggle (@Lovoov3) and the license to use the data set is available on creativecommons (@License). We decided to explore the variables age, counts_pictures, counts_profileVisits, counts_kisses, distance, country and isVip.

**Age** is the users age, **counts_pictures** is the number of pictures on the user's profile, **counts_profileVisits** is the number of clicks on this user (to see his/her full profile) from other user accounts, **counts_kisses** is the number of unique user accounts that "liked" (called "kiss" on the platform) this user account, **distance** is the distance between this user's city/location and the location of the user account that was used to fetch the data of this user, **country** is the user's country, **isVip** is a 1 if the user is VIP. [It was possible to buy a VIP status with real money. This status came with benefits.].

It was discovered that there were 46 missing values in the variable distance. These have been replaced by the mean of the distance column (207.23). After replacing the 46 missing distance variables to ensure we have a full data set, we have a sample size of 3992 for all seven variables. 

The ages of the user's of the lovoo app range from 18 years to 28 years with the median age being 22 year. The minimum number of pictures on a user's profile is 0 with the maximum being 30 pictures and the median being 4.The number of clicks on a user's profile to see his/her full profile (from another users account) ranges from 0 to 164425 clicks, with the median being 1222 clicks. The number of unique user accounts that "liked" a users account ranges from 0 to 9288 likes, with the median being 44 likes. The distance between this user's city/location and the location of the user account that was used to fetch the data of the user ranges from 0 to 6918, with the median being 173. These and other summary statistics can be seen in table \@ref(SumStat). 

As identified in the summary statistics the median age is 22 and this is supported by the boxplot in figure \@ref(fig:ageplot). We can also see that the mean age is equal to 22 also. The green line shows the estimated normal density for the age. The age of the users appears to be normally distributed. The blue line shows the smoothed density histogram for age, this appears to go down between each value of age. This is likely to the fact that age has been measured discretely and the smoothed histogram is continuous. 
*We are unsure as to why we are getting a warning message for figure \@ref(fig:ageplot) as there is no missing data for age.*

The bulk of users tend to have less than 10 profile pictures on their account. We can see from the boxplot in figure \@ref(fig:picturesplot) that there are a number of users that have a higher number of profile pictures on their account. This is also visible in the histogram which shows a long tail to the right.

The original graph for the number of profile visits a user has is very hard to read, so figure \@ref(fig:visitsplot) shows the squre root transformed data. This is still hard to read due to an extreme outlier (+100,000 visits counted). We removed the extreme outlier in order to better read the graph. We can see in figure \@ref(fig:visitsplot2) that mean is much closer to the 75% percentile than it is the median. User's tend to have between 0 and 4000 profile visits, however, about 25% of user's have a much higher number of visits and this is skewing the data.

The number of 'kisses' a user receives appears to be heavily skewed to the right. There are a large number of outliers or large values.The mean appears to be larger than the 75% percentile as seen in figure \@ref(fig:kisssplot).

There are 32 different countries that users come from. The summary of the countries and their counts can be found in table \@ref(Countryfreq) and a visualisation can be seen in figure \@ref(fig:barcountry). Table \@ref(vipfreq) shows that 3901 users are not Vip's while only 91 are Vip's and figure \@ref(fig:purchasedVip) shows a visualisation.

```{r, echo=FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", 
                   "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Replacing country codes with full names
lovoo["country"][lovoo["country"] == 'AR'] <- 'Argentina'
lovoo["country"][lovoo["country"] == 'AT'] <- 'Austria'
lovoo["country"][lovoo["country"] == 'AU'] <- 'Australia'
lovoo["country"][lovoo["country"] == 'BA'] <- 'Bosnia and Herzegovina'
lovoo["country"][lovoo["country"] == 'BE'] <- 'Belgium'
lovoo["country"][lovoo["country"] == 'BR'] <- 'Brazil'
lovoo["country"][lovoo["country"] == 'CA'] <- 'Canada'
lovoo["country"][lovoo["country"] == 'CF'] <- 'Central African Republic'
lovoo["country"][lovoo["country"] == 'CH'] <- 'Switzerland'
lovoo["country"][lovoo["country"] == 'CZ'] <- 'Czechia'
lovoo["country"][lovoo["country"] == 'DE'] <- 'Germany'
lovoo["country"][lovoo["country"] == 'ES'] <- 'Spain'
lovoo["country"][lovoo["country"] == 'ET'] <- 'Ethiopia'
lovoo["country"][lovoo["country"] == 'FR'] <- 'France'
lovoo["country"][lovoo["country"] == 'GB'] <- 'United Kingdom of Great Britain and Northern Ireland'
lovoo["country"][lovoo["country"] == 'HU'] <- 'Hungary'
lovoo["country"][lovoo["country"] == 'ID'] <- 'Indonesia'
lovoo["country"][lovoo["country"] == 'IN'] <- 'India'
lovoo["country"][lovoo["country"] == 'IT'] <- 'Italy'
lovoo["country"][lovoo["country"] == 'JM'] <- 'Jamaica'
lovoo["country"][lovoo["country"] == 'LI'] <- 'Liechtenstein'
lovoo["country"][lovoo["country"] == 'LR'] <- 'Liberia'
lovoo["country"][lovoo["country"] == 'LU'] <- 'Luxembourg'
lovoo["country"][lovoo["country"] == 'NL'] <- 'Netherlands'
lovoo["country"][lovoo["country"] == 'PE'] <- 'Peru'
lovoo["country"][lovoo["country"] == 'PH'] <- 'Philippines'
lovoo["country"][lovoo["country"] == 'RO'] <- 'Romania'
lovoo["country"][lovoo["country"] == 'RU'] <- 'Russian Federation'
lovoo["country"][lovoo["country"] == 'SC'] <- 'Seychelles'
lovoo["country"][lovoo["country"] == 'TR'] <- 'Turkey'
lovoo["country"][lovoo["country"] == 'UA'] <- 'Ukraine'
lovoo["country"][lovoo["country"] == 'US'] <- 'United States of America'

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)
```

```{r, echo=FALSE}
# creating summary statistics
MySummary <- function(df){
  (c(length(df), min(df), quantile(df, .25), median(df), quantile(df, .75),
     max(df), IQR(df), sd(df), mean(df)))
}
```

```{r results = 'asis', echo=FALSE}
SumStat <- apply(lovoo[,1:5], MySummary, MARGIN=2)
rownames(SumStat) <- c("sample size", "minimum", "first quartile", "median",
                       "third quartile", "maximum", "IQR", 
                       "standard deviation", "mean")

print(xtable(SumStat, caption="Summary Statistics - Numerical Variables", 
             label="SumStat"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r ageplot, fig.cap="Age", echo=FALSE}
ageplot <- ggplot(lovoo, aes(x=age)) +
  geom_histogram(aes(y=..density..),
                 binwidth = 1,
                 col='black', fill='white') +
  scale_x_continuous(breaks = seq(17,29,1), lim = c(17,29)) +
  labs(x = 'Age',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Visualisation of the user's age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$age), 
                                         sd = sd(lovoo$age)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$age), col="red", size=1) +
  theme_tufte()

ageplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r picturesplot, fig.cap="Profile pictures", echo=FALSE}
picsplot <- ggplot(lovoo, aes(x=counts_pictures)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$counts_pictures)),
                 col='black', fill='white') +
  labs(x = 'Number of Profile Pictures',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Visualisation of the number of profile pictures a user has") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$counts_pictures), 
                                         sd = sd(lovoo$counts_pictures)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$counts_pictures), col="red", size=1) +
  theme_tufte()

picsplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r visitsplot, fig.cap="Square-root transformed Profile visits", echo=FALSE}
visitsplot <- ggplot(lovoo, aes(x=counts_profileVisits)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$counts_profileVisits)),
                 col='black', fill='white') +
  labs(x = 'Number of Profile Visits',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Visualisation of the squre-root transformed number of profile visits") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.01), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$counts_profileVisits), 
                                         sd = sd(lovoo$counts_profileVisits)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$counts_profileVisits), col="red", size=1) +
  theme_tufte() +
  scale_x_continuous(trans = 'sqrt')

visitsplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r visitsplot2, fig.cap="Square-root transformed Profile visits - minus the outlier", echo=FALSE, warning=FALSE}
dating_r<-lovoo$counts_profileVisits
dating_removed<-dating_r[dating_r<100000]

mz <- mean(dating_removed)
sdz <- sd(dating_removed)

dating_removed_df<-as.data.frame(dating_removed)

ggplot(dating_removed_df, aes(x=dating_removed)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$counts_profileVisits)),
                 col="black", fill="white") +
  xlab("Number of profile Visits") +
  ylab("Histogram, smoothed histogram, and estimated normal density") +
  ggtitle("Visualisation of the squre-root transformed Profile Visits (minus outlier)")+
  geom_density(col='blue', size=1.5) +
  stat_function(fun = "dnorm", args=list(mean=mz, sd=sdz), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mz, col="red", size=1) +
  geom_boxplot(aes(y=-.02), width=.01, notch = TRUE, col='blue')+
  theme_tufte() + scale_x_continuous(trans = 'sqrt')
```

```{r kisssplot, fig.cap="Profile Likes", echo=FALSE}
kissplot <- ggplot(lovoo, aes(x=counts_kisses)) +
  geom_histogram(aes(y=(..density..)^0.5),
                 bins=nclass.FD(unlist(lovoo$counts_kisses)),
                 col='black', fill='white') +
  labs(x = 'Number of Profile kisses',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Number of Likes a user's profile has") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$counts_kisses), 
                                         sd = sd(lovoo$counts_kisses)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$counts_kisses), col="red", size=1) +
  theme_tufte() +
  scale_x_continuous(trans = 'sqrt')

kissplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r distplot, fig.cap="Distance", echo=FALSE}
distplot <- ggplot(lovoo, aes(x=distance)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$distance)),
                 col='black', fill='white') +
  labs(x = 'Distance',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Distance between user's") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$distance), 
                                         sd = sd(lovoo$distance)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$distance), col="red", size=1) +
  theme_tufte() +
  scale_x_continuous(trans = 'sqrt')

distplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r results = 'asis', echo=FALSE}
vip_freq <- table(lovoo$isVip)
vip_freq <- data.frame(vip_freq)
colnames(vip_freq) <- c("isVip", "Count")
rownames(vip_freq) <- c("No", "Yes")
print(xtable(vip_freq, caption="Summary Statistics - isVip", label="vipfreq"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r purchasedVip, fig.cap='Count of whether a user is a VIP (nor not)', echo=FALSE}
barplot(table(lovoo$isVip), col = "blue", main = "Purchased Vip", xlab = "Purchased", ylab = "Count", ylim = c(1, 4000))
```

```{r results = 'asis', echo=FALSE}
coun_freq <- table(lovoo$country)
coun_freq <- data.frame(coun_freq)
colnames(coun_freq) <- c("Country", "Count")
print(xtable(coun_freq, caption="Summary Statistics - Countires", label="Countryfreq"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r barcountry, fig.cap="Number of user's by Country", echo=FALSE}
countrybar <- ggplot(lovoo, aes(x=country)) +
  geom_bar(fill='blue') +
  ggtitle("Count of user's by country") +
  theme_tufte()

countrybar + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

After the initial analysis of our variables we noticed that four of the countries (Switzerland (CH), Germany (DE), France
(FR) and Italy (IT)) have significantly larger number of users compared to the other 28 countries. The other countries have between 1 and 20 users, we decided that we would group all other countries into one category called 'other' and explore the data further. Even with grouping the 28 countries they still have the lowest number of users out of the five new groups. The 'other' group has 83 users as seen in table \@ref(Countryfreq2). A visualisation of the users by country can be seen in figure \@ref(fig:barcountry2).

```{r, echo=FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Replacing variable names
lovoo["country"][lovoo["country"] == 'CH'] <- 'Switzerland'
lovoo["country"][lovoo["country"] == 'DE'] <- 'Germany'
lovoo["country"][lovoo["country"] == 'FR'] <- 'France'
lovoo["country"][lovoo["country"] == 'IT'] <- 'Italy'
lovoo["country"][lovoo["country"] == 'AR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AT'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CF'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CZ'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ES'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ET'] <- 'Other'
lovoo["country"][lovoo["country"] == 'GB'] <- 'Other'
lovoo["country"][lovoo["country"] == 'HU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ID'] <- 'Other'
lovoo["country"][lovoo["country"] == 'IN'] <- 'Other'
lovoo["country"][lovoo["country"] == 'JM'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LI'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'NL'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PH'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RO'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'SC'] <- 'Other'
lovoo["country"][lovoo["country"] == 'TR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'UA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'US'] <- 'Other'

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)
```

```{r results = 'asis', echo=FALSE}
coun_freq <- table(lovoo$country)
coun_freq <- data.frame(coun_freq)
colnames(coun_freq) <- c("Country", "Count")
print(xtable(coun_freq, caption="Summary Statistics - with grouped countries", label="Countryfreq2"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r barcountry2, fig.cap="Number of user's by Country", echo=FALSE}
countrybar2 <- ggplot(lovoo, aes(x=country)) +
  geom_bar(fill='blue') +
  ggtitle("Count of user's by country") +
  theme_tufte()

countrybar2 + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

# Bivariate and Multivariate

There appears to be strong positive correlation between the number of profiles visits and the number of likes that a user receives. There is also positive correlation between the number of pictures a user has and the number of profile visits they receive, as well as the number of likes the user has. There is slight positive correlation between the age of the user and the distance between this user's city/location and the location of the user account that was used to fetch the data of the user. There appears to be no correlation between age and likes, profile visits and pictures, nor distance and likes, profile visits and pictures. This can been seen in figure \@ref(fig:correlationmatrix) and numerically in table \@ref(correlationmatrixnum), and supported by the pairs plots in figure \@ref(fig:pairsplot).

Earlier we saw that there was significantly more non-Vip user's than Vip users (table \@ref(vipfreq)). In  shows that 3901 users are not Vip's while only 91 are Vip's. We can see in table \@ref(vipcountry) that Switzerland has the most Vip's, this is supported in figure \@ref(fig:plotvip).

We see that there is a high correlation (0.89) between profile visits and profile likes (table \@ref(correlationmatrixnum)). We see from figure \@ref(fig:scatterplot) that there is a positive relationship between profile visits and profile likes. We can also see there are several outliers that we should remove as they can be very influential to our data. After removing the outliers from figure \@ref(fig:scatterplot) we see the same positive relationship but the outlieing profiles are gone (figure \@ref(fig:scatterplot2)).

We see that the number of users by age tends to increase in Germany and peak at 22 years old before decreasing. Where as in France and Switzerland they tend to start with a larger number of users at younger age and decrease as age increases. This can be seen in figure \@ref(fig:plotage).

```{r correlationmatrix, fig.cap="Correlation Matrix", echo=FALSE, warning=FALSE}
ggcorrplot(cor(lovoo[,1:5]),
           method = "circle",
           hc.order = TRUE,
           type = "lower") +
  ggtitle("Correlation Matrix") 
```

```{r results = 'asis', echo=FALSE, warning=FALSE}
c <- cor(lovoo[,1:5])

print(xtable(c, caption="Correlation matrix", label="correlationmatrixnum"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r pairsplot, fig.cap='Pairs plot', echo=FALSE}
ggpairs(lovoo[,1:5]) +
  ggtitle("Pairs plots of age, pictures, profile visits, likes and distance") +
  theme(plot.title=element_text(hjust=0.5)) 
```

```{r results = 'asis', echo=FALSE}
newtab <- table(lovoo$country, lovoo$isVip)
colnames(newtab) <- c("isVip - No", "isVip - Yes")
print(xtable(newtab, caption="Summary Statistics - isVip (or not) by country", label="vipcountry"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r plotvip, fig.cap='Count of users by country and Vip status ', echo=FALSE}
ggplot(lovoo) +
  geom_bar(aes(x = country, fill = isVip)) +
  ggtitle("Count of users by country and Vip status") +
  theme_tufte() +
  theme(plot.title=element_text(hjust=0.5))
```

```{r plotage, fig.cap='Number of users by age and country' ,echo=FALSE}
ggplot(lovoo, aes(x=country)) +
  geom_bar(aes(fill=country)) + 
  ylab(label='Number of users') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(~age)
```

```{r, echo=FALSE}
lovoo2 <- lovoo[, c("counts_profileVisits", "counts_kisses", "isVip")]
```

```{r scatterplot, fig.cap='Scatterplot of profile visits vs profile likes', echo=FALSE}
plot(lovoo2$counts_profileVisits, lovoo2$counts_kisses, main="Profile visits against Profile likes",
   xlab="Profile Visits", ylab="Profile Likes")
abline(lm(lovoo2$counts_kisses ~ lovoo2$counts_profileVisits, data = lovoo2), col = "red")
```

```{r , echo=FALSE}
Q1visits <- quantile(lovoo2$counts_profileVisits, .25)
Q3visits <- quantile(lovoo2$counts_profileVisits, .75)

Q1likes <- quantile(lovoo2$counts_kisses, .25)
Q3likes <- quantile(lovoo2$counts_kisses, .75)

IQRvisits <- IQR(lovoo2$counts_profileVisits)
IQRlikes <- IQR(lovoo2$counts_kisses)

lovoo2 <- subset(lovoo2, lovoo2$counts_profileVisits > (Q1visits - 1.5*IQRvisits) & lovoo2$counts_profileVisits < (Q3visits + 1.5*IQRvisits))
lovoo2 <- subset(lovoo2, lovoo2$counts_kisses > (Q1likes - 1.5*IQRlikes) & lovoo2$counts_kisses < (Q3likes + 1.5*IQRlikes))
```

```{r scatterplot2, fig.cap='Revised scatterplot of profile visits vs profile likes', echo=FALSE}
plot(lovoo2$counts_profileVisits, lovoo2$counts_kisses, main="Revised - Profile visits against Profile likes",
   xlab="Profile Visits", ylab="Profile Likes")
abline(lm(lovoo2$counts_kisses ~ lovoo2$counts_profileVisits, data = lovoo2), col = "red", lwd=2)
```

# Burning questions

## Profile Visits, Like, Country and Vip

After our initial analysis we know that profile visits and profile likes are highly correlated. We want to know if the number of profile visits and likes varies from country. We are also interested to know if having Vip status in each country affects the number of profile visits and likes.

There appears to be a positive correlation between the number of profile pictures a user has and the number of profile visits they receive, as well as the number of likes the profile receives. It appears that having Vip status has a higher correlation in these cases. The number of likes on a profile and the number of profile visits is strongly positively correlated, this is only slightly higher in Vip's compared to non-Vip's as seen in figure \@ref(fig:pairsplotvip). The correlation between countries for these variables varies a little. The biggest thing to note is that Italy appears to have a correlation of 0.947 between the number of likes a user has and the number of visits (figure \@ref(fig:pairsplotcountry)).

The boxplot of the number of profile visits and likes by country is very hard to read (figure \@ref(fig:boxlikeviscountry)), we have transformed this by taking the log of profile likes. We can see from th revised boxplot (figure \@ref(fig:boxlikeviscountry)) that Germany has the largest range of profile visits while France has the least. France, Germany and Italy have very similar ranges of the number of profile likes. Our group of 'other' countries appears to have the largest median for the number of profile likes. We can conclude that there is a difference in the number of profile visits and the number of profile likes for each country.

Looking at figure \@ref(fig:boxlikeviscountryvip) we can see that having Vip status tends to improve the number of profile likes a user receives in our four main countries. However this is not the case in the 'other' countries as only 1 person from 'other' has Vip status. The biggest difference can be seen in Germany.

To conclude if you live in Germany and you want more profile likes then you should like to purchase Vip status.

```{r, echo=FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Replacing variable names
lovoo["country"][lovoo["country"] == 'CH'] <- 'Switzerland'
lovoo["country"][lovoo["country"] == 'DE'] <- 'Germany'
lovoo["country"][lovoo["country"] == 'FR'] <- 'France'
lovoo["country"][lovoo["country"] == 'IT'] <- 'Italy'
lovoo["country"][lovoo["country"] == 'AR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AT'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CF'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CZ'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ES'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ET'] <- 'Other'
lovoo["country"][lovoo["country"] == 'GB'] <- 'Other'
lovoo["country"][lovoo["country"] == 'HU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ID'] <- 'Other'
lovoo["country"][lovoo["country"] == 'IN'] <- 'Other'
lovoo["country"][lovoo["country"] == 'JM'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LI'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'NL'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PH'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RO'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'SC'] <- 'Other'
lovoo["country"][lovoo["country"] == 'TR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'UA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'US'] <- 'Other'

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)
```

```{r pairsplotvip, fig.cap="Pairs plot by isVip",warning = FALSE, echo=FALSE}
ggpairs(lovoo[,1:5],
ggplot2::aes(col=lovoo$isVip, alpha=.5)) +
ggplot2::scale_color_manual(values=c("green", "blue")) +
ggplot2::theme(axis.text.x = element_text(angle=90, hjust=1))
```

```{r pairsplotcountry, fig.cap="Pairs plot by country",warning = FALSE, echo=FALSE}
ggpairs(lovoo[,1:5],
ggplot2::aes(col=lovoo$country, alpha=.5)) +
ggplot2::scale_color_manual(values=c("lightgray", "green", "blue", "red", "orange")) +
ggplot2::theme(axis.text.x = element_text(angle=90, hjust=1))
```

```{r boxlikeviscountry, fig.cap='Boxplot of profile visits and likes by country', echo=FALSE}
ggplot(lovoo, aes(x=counts_profileVisits, y=counts_kisses)) +
  geom_boxplot(aes(col=country), notch=TRUE) +
  xlab('Number of Profile Visits') + 
  ylab('Number of Profile Likes') +
  ggtitle("Profile Visits vs Profile Likes") +
  facet_grid(~ country) +
  theme(axis.text.x = element_text(size=7, angle=90, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r boxlikeviscountry2, fig.cap='Revised boxplot of profile visits and likes by country', echo=FALSE}
ggplot(lovoo, aes(x=counts_profileVisits, y=log(counts_kisses))) +
  geom_boxplot(aes(col=country), notch=TRUE) +
  xlab('Number of Profile Visits') + 
  ylab('Number of Profile Likes') +
  ggtitle("Profile Visits vs Log Profile Likes") +
  facet_grid(~ country) +
  theme(axis.text.x = element_text(size=7, angle=90, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r boxlikeviscountryvip, fig.cap='Revised boxplot of profile visits and likes by country and vip', echo=FALSE}
ggplot(lovoo, aes(x=counts_profileVisits, y=log(counts_kisses))) +
  geom_boxplot(aes(col=country), notch=TRUE) +
  xlab('Number of Profile Visits') + 
  ylab('Number of Profile Likes') +
  ggtitle("Profile Visits, Log Profile Likes for each country and Vip") +
  facet_grid(~ isVip) +
  theme(axis.text.x = element_text(size=7, angle=90, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

# Normality Test

```{r echo = FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
#lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", 
                   "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

less_eq_20 = names(table(lovoo$country))[table(lovoo$country) <= 20]
lovoo$country[lovoo$country %in% less_eq_20] = "OTHER"
#table(lovoo$country)
```

```{r echo = FALSE}
# Country
Switzerland <- lovoo[lovoo$country == "CH", ]
Switzerland <- data.frame(Switzerland)
Germany <- lovoo[lovoo$country == "DE", ]
Germany <- data.frame(Germany)
France <- lovoo[lovoo$country == "FR", ]
France <- data.frame(France)
Italy <- lovoo[lovoo$country == "IT",]
Italy <- data.frame(Italy)
Other <- lovoo[lovoo$country == "OTHER", ]
Other <- data.frame(Other)

# isVip
isavip <- lovoo[lovoo$isVip == 1, ]
isnotavip <- lovoo[lovoo$isVip == 0, ]
```

## Shapiro-Wilks test of normality

```{r echo = FALSE}
# Goodness of Fit test - factor is a vip
shapiro.test(isavip$age)
shapiro.test(isavip$counts_pictures)
shapiro.test(isavip$counts_profileVisits)
shapiro.test(isavip$counts_kisses)
shapiro.test(isavip$distance)

# Goodness of Fit test - factor is not a vip
shapiro.test(isnotavip$age)
shapiro.test(isnotavip$counts_pictures)
shapiro.test(isnotavip$counts_profileVisits)
shapiro.test(isnotavip$counts_kisses)
shapiro.test(isnotavip$distance)

# Goodness of fit test - factor Switzerland
shapiro.test(Switzerland$age)
shapiro.test(Switzerland$counts_pictures)
shapiro.test(Switzerland$counts_profileVisits)
shapiro.test(Switzerland$counts_kisses)
shapiro.test(Switzerland$distance)

# Goodness of fit test - factor Germany
shapiro.test(Germany$age)
shapiro.test(Germany$counts_pictures)
shapiro.test(Germany$counts_profileVisits)
shapiro.test(Germany$counts_kisses)
shapiro.test(Germany$distance)

## Goodness of fit test - factor France
shapiro.test(France$age)
shapiro.test(France$counts_pictures)
shapiro.test(France$counts_profileVisits)
shapiro.test(France$counts_kisses)
shapiro.test(France$distance)

# Goodness of fit test - factor Italy
shapiro.test(Italy$age)
shapiro.test(Italy$counts_pictures)
shapiro.test(Italy$counts_profileVisits)
shapiro.test(Italy$counts_kisses)
shapiro.test(Italy$distance)

# Goodness of fit test - factor Other
shapiro.test(Other$age)
shapiro.test(Other$counts_pictures)
shapiro.test(Other$counts_profileVisits)
shapiro.test(Other$counts_kisses)
shapiro.test(Other$distance)
```

all tests of normality's p-values support rejecting the null hypothesis ($H_{0}$: the population follows a normal distribution.) So, we believe that none of the variables factors follow a normal distribution. 

## Quantile-Quantile Plots

```{r warning = FALSE, echo = FALSE}
# factor is a vip
plot1 <- ggplot(isavip, aes(sample = age)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is a VIP - Age") + stat_qq_line()
plot2 <- ggplot(isavip, aes(sample = counts_pictures)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is a VIP - Count of Pictures") + stat_qq_line()
plot3 <-ggplot(isavip, aes(sample = counts_profileVisits)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is a VIP - Profile visits") + stat_qq_line()
plot4 <- ggplot(isavip, aes(sample = counts_kisses)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is a VIP - Count of Kisses") + stat_qq_line()
plot5 <- ggplot(isavip, aes(sample = distance)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is a VIP - Distance") + stat_qq_line()
```

```{r fig.height = 10, fig.cap = "factor: isavip", warning = FALSE, echo = FALSE}
fig.1 <- ggarrange(plot1, plot2, plot3, plot4, plot5, nrow = 3, ncol = 2)
fig.1
```

```{r echo = FALSE}
# factor is a vip
plot6 <- ggplot(isnotavip, aes(sample = age)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is not a VIP - Age") + stat_qq_line()
plot7 <- ggplot(isnotavip, aes(sample = counts_pictures)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is not a VIP - Count of Pictures") + stat_qq_line()
plot8 <- ggplot(isnotavip, aes(sample = counts_profileVisits)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is not a VIP - Profile visits") + stat_qq_line()
plot9 <- ggplot(isnotavip, aes(sample = counts_kisses)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is not a VIP - Count of Kisses") + stat_qq_line()
plot10 <- ggplot(isnotavip, aes(sample = distance)) + stat_qq(size = 0.5, col = "Blue") + labs(title = "Is not a VIP - Distance") + stat_qq_line()
```

```{r fig.height = 10, fig.cap = "factor: isnotavip", warning = FALSE, echo = FALSE}
fig.2 <- ggarrange(plot6, plot7, plot8, plot9, plot10, nrow = 3, ncol = 2)
fig.2
```

```{r warning = FALSE, echo = FALSE}
# factor Switzerland
plot11 <- ggplot(Switzerland, aes(sample = age)) + stat_qq(size = 0.5, col = "Green") + labs(title = "Switzerland - Age") + stat_qq_line()
plot12 <- ggplot(Switzerland, aes(sample = counts_pictures)) + stat_qq(size = 0.5, col = "Green") + labs(title = "Switzerland - Count of Pictures") + stat_qq_line()
plot13 <- ggplot(Switzerland, aes(sample = counts_profileVisits)) + stat_qq(size = 0.5, col = "Green") + labs(title = "Switzerland - Profile visits") + stat_qq_line()
plot14 <- ggplot(Switzerland, aes(sample = counts_kisses)) + stat_qq(size = 0.5, col = "Green") + labs(title = "Switzerland - Count of Kisses") + stat_qq_line()
plot15 <- ggplot(Switzerland, aes(sample = distance)) + stat_qq(size = 0.5, col = "Green") + labs(title = "Switzerland - Distance") + stat_qq_line()
```

```{r fig.height = 10, fig.cap = "factor: Switzerland", warning = FALSE,  echo = FALSE}
fig.3 <- ggarrange(plot11, plot12, plot13, plot14, plot15, nrow = 3, ncol = 2)
fig.3
```

```{r warning = FALSE, echo = FALSE}
# factor Germany
plot16 <- ggplot(Germany, aes(sample = age)) + stat_qq(size = 0.5, col = "Orange") + labs(title = "Germany - Age") + stat_qq_line()
plot17 <- ggplot(Germany, aes(sample = counts_pictures)) + stat_qq(size = 0.5, col = "Orange") + labs(title = "Germany - Count of Pictures") + stat_qq_line()
plot18 <- ggplot(Germany, aes(sample = counts_profileVisits)) + stat_qq(size = 0.5, col = "Orange") + labs(title = "Germany - Profile visits") + stat_qq_line()
plot19 <- ggplot(Germany, aes(sample = counts_kisses)) + stat_qq(size = 0.5, col = "Orange") + labs(title = "Germany - Count of Kisses") + stat_qq_line()
plot20 <-ggplot(Germany, aes(sample = distance)) + stat_qq(size = 0.5, col = "Orange") + labs(title = "Germany - Distance") + stat_qq_line()
```

```{r fig.height = 10, fig.cap = "factor: Germany", warning = FALSE, echo = FALSE}
fig.4 <- ggarrange(plot16, plot17, plot18, plot19, plot20, nrow = 3, ncol = 2)
fig.4
```

```{r warning = FALSE, echo = FALSE}
# factor France
plot21 <- ggplot(France, aes(sample = age)) + stat_qq(size = 0.5, col = "Pink") + labs(title = "France - Age") + stat_qq_line()
plot22 <- ggplot(France, aes(sample = counts_pictures)) + stat_qq(size = 0.5, col = "Pink") + labs(title = "France - Count of Pictures") + stat_qq_line()
plot23 <- ggplot(France, aes(sample = counts_profileVisits)) + stat_qq(size = 0.5, col = "Pink") + labs(title = "France - Profile visits") + stat_qq_line()
plot24 <- ggplot(France, aes(sample = counts_kisses)) + stat_qq(size = 0.5, col = "Pink") + labs(title = "France - Count of Kisses") + stat_qq_line()
plot25 <- ggplot(France, aes(sample = distance)) + stat_qq(size = 0.5, col = "Pink") + labs(title = "France - Distance") + stat_qq_line()
```

```{r fig.height = 10, fig.cap = "factor: France", warning = FALSE, echo = FALSE}
fig.5 <- ggarrange(plot21, plot22, plot23, plot24, plot25, nrow = 3, ncol = 2)
fig.5
```

```{r warning = FALSE, echo = FALSE}
# factor Italy
plot26 <- ggplot(Italy, aes(sample = age)) + stat_qq(size = 0.5, col = "Purple") + labs(title = "Italy - Age") + stat_qq_line()
plot27 <- ggplot(Italy, aes(sample = counts_pictures)) + stat_qq(size = 0.5, col = "Purple") + labs(title = "Italy - Count of Pictures") + stat_qq_line()
plot28 <- ggplot(Italy, aes(sample = counts_profileVisits)) + stat_qq(size = 0.5, col = "Purple") + labs(title = "Italy - Profile visits") + stat_qq_line()
plot29 <- ggplot(Italy, aes(sample = counts_kisses)) + stat_qq(size = 0.5, col = "Purple") + labs(title = "Italy - Counts of Kisses") + stat_qq_line()
plot30 <- ggplot(Italy, aes(sample = distance)) + stat_qq(size = 0.5, col = "Purple") + labs(title = "Italy - Distance") + stat_qq_line()
```

```{r fig.height = 10, fig.cap = "factor: Italy", warning = FALSE, echo = FALSE}
fig.6 <- ggarrange(plot26, plot27, plot28, plot29, plot30, nrow = 3, ncol = 2)
fig.6
```

```{r warning = FALSE, echo = FALSE}
# factor Other
plot31 <- ggplot(Other, aes(sample = age)) + stat_qq(size = 0.5, col = "Yellow") + labs(title = "Other - Age") + stat_qq_line()
plot32 <- ggplot(Other, aes(sample = counts_pictures)) + stat_qq(size = 0.5, col = "Yellow") + labs(title = "Other - Count of Pictures") + stat_qq_line()
plot33 <- ggplot(Other, aes(sample = counts_profileVisits)) + stat_qq(size = 0.5, col = "Yellow") + labs(title = "Other - Profile visits") + stat_qq_line()
plot34 <- ggplot(Other, aes(sample = counts_kisses)) + stat_qq(size = 0.5, col = "Yellow") + labs(title = "Other - Counts of Kisses") + stat_qq_line()
plot35 <- ggplot(Other, aes(sample = distance)) + stat_qq(size = 0.5, col = "Yellow") + labs(title = "Other - Distance") + stat_qq_line()
```

```{r fig.height = 10, fig.cap = "factor: Other", warning = FALSE, echo = FALSE}
fig.7 <- ggarrange(plot31, plot32, plot33, plot34, plot35, nrow = 3, ncol = 2)
fig.7
```
\
\
All of the Q-Q plots support the quantitative analysis, the QQ points have points off the line in its tail which violate the assumption of normality.


# Testing for class membership using Mahalanobis distance (isVip)

Firstly, we will subset the data based on whether or not the user is a VIP, then iterate through each observation and check it against the data as if it were a new sample. We will take it's measures (pictures, visits, and kisses) and delete it from the data set. 

From this we will estimate the mean and covariance vectors of the measures to find the distance between the observation and the measurement model (using df = 3). The p-value of each distance will be recorded as that shows how significant the distance is and helps us to reject or accept the null hypothesis. Our alpha level is 0.05.

Hypothesis: 
+ H0: $x_{obs}$ is not consistent with the ideal distance
+ H1: $x_{obs}$ is consistent with the ideal distance

From figure \@ref(fig:mahadistVIP) we can see that for about 170 observations of non VIPs have p-values lower than our alpha level, so we reject the null hypothesis and conclude they are not consistent with the ideal distance. For the VIPs, 8 observations will reject the null hypothesis. 

This is a good result for our data, meaning only a small proportion of our data needs to be looked into for outlier removal. 

```{r mahadistVIP, fig.cap="Histograms of Mahalanobis Distance p-values", echo=FALSE, warning=FALSE}
plots <- vector('list', length(c(0,1)))
titles <- c("Non VIP", "VIP")

for (x in c(0,1)){
  dating <- lovoo[c("counts_pictures", "counts_profileVisits", "counts_kisses", "isVip")]
  dating<-subset(dating, isVip==x)
  pvals_v <- vector('list', nrow(dating))
  for (i in 1:nrow(dating)) {
    x.new <- dating[i,-4]
    dating <- dating %>%  filter(!row_number() %in% c(i))
    est.mu <- colMeans(dating[, -4])
    est.covar <- var(dating[, -4])
  
    d.new <- mahalanobis(x.new, center = est.mu, cov = est.covar)
    pvals_v[[i]] = pchisq(d.new, df = 3, lower.tail = FALSE)
  }
  df<-data.frame(val = unlist(pvals_v)) 
  plots[[x+1]] = ggplot(df, aes(val)) +   geom_histogram(bins=15) + theme_bw() +
  geom_vline(xintercept = 0.05, col="red") + xlab("P-value obtained per observation") + ggtitle(titles[x+1])+
    ylab("Count of observations")
}
ggarrange(plotlist=plots,ncol = 2, nrow = 1)

```

# Testing for class membership using Mahalanobis distance (Country)

We will subset the data based on the country the profile is from, we will then go through each observation and check it against the data as if it were a new sample.

```{r mahadistCountry, fig.cap="Histograms of Mahalanobis Distance p-values", echo=FALSE, warning=FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", 
                   "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Replacing country codes with full names
lovoo["country"][lovoo["country"] == 'CH'] <- 'Switzerland'
lovoo["country"][lovoo["country"] == 'DE'] <- 'Germany'
lovoo["country"][lovoo["country"] == 'FR'] <- 'France'
lovoo["country"][lovoo["country"] == 'IT'] <- 'Italy'
lovoo["country"][lovoo["country"] == 'AR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AT'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CF'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CZ'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ES'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ET'] <- 'Other'
lovoo["country"][lovoo["country"] == 'GB'] <- 'Other'
lovoo["country"][lovoo["country"] == 'HU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ID'] <- 'Other'
lovoo["country"][lovoo["country"] == 'IN'] <- 'Other'
lovoo["country"][lovoo["country"] == 'JM'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LI'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'NL'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PH'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RO'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'SC'] <- 'Other'
lovoo["country"][lovoo["country"] == 'TR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'UA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'US'] <- 'Other'

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)

plots <- vector('list', length(c("France", "Germany", "Italy", "Other", "Switzerland")))
y<-1

for (x in c("France", "Germany", "Italy", "Other", "Switzerland")){
  dating <- lovoo[c("counts_pictures", "counts_profileVisits", "counts_kisses", "country")]
  dating<-subset(dating, country==x)
  pvals_v <- vector('list', nrow(dating))
  for (i in 1:nrow(dating)) {
    x.new <- dating[i,-4]
    dating <- dating %>%  filter(!row_number() %in% c(i))
    est.mu <- colMeans(dating[, -4])
    est.covar <- var(dating[, -4])
  
    d.new <- mahalanobis(x.new, center = est.mu, cov = est.covar)
    pvals_v[[i]] = pchisq(d.new, df = 3, lower.tail = FALSE)
  }
  df<-data.frame(val = unlist(pvals_v)) 
  plots[[y]] = ggplot(df, aes(val)) +   geom_histogram(bins=10) + theme_bw() +
  geom_vline(xintercept = 0.05, col="red") + xlab("P-value obtained per obs") + ggtitle(x)
  y<-y+1
}

ggarrange(plotlist=plots,ncol = 3, nrow = 2)

outlierpvals <- pvals_v
outlierpvals <- data.frame(outlierpvals)
outlierpvals <- outlierpvals[outlierpvals < 0.05]
outlierpvals_2 <- na.omit(outlierpvals)
#dim(data.frame(outlierpvals_2))[1]
```

In general, the p-value reflects the probability of seeing a Mahalanobis value as large or larger than the actual Mahalanobis value, assuming the vector of predictor values that produced that Mahalanobis value was sampled from a population with an ideal mean (i.e. equal to the vector of mean predictor variable values used to generate the Mahalanobis value). P-values close to 0 reflect high Mahalanobis distance values and are therefore very dissimilar to the ideal combination of predictor variables. P-values close to 1 reflect low Mahalanobis distances and are therefore very similar to the ideal combination of predictor variables. The closer the p-value is to 1, the more similar that combination of predictor values is to the ideal combination. There are 75 observations that have a p-value of less than our chosen alpha level of 0.05. Those observations can be considered outliers as they are too far from our ideal combination of predictor variables.



# References

