---
title: "Exploratory Data Analysis"
author: "Lissa Harrop, Katrina Watkins, Ricky Loo and Max Tan"
date: "September 2022"
classoption: 12pt
  
header-includes:
  - \usepackage{newpxtext,eulerpx}
  - \usepackage{bm,bbm}

output: bookdown::pdf_document2

link-citations: yes
bibliography: references.bib

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
set.seed(300521444, kind="Mersenne-Twister") #Mixture of all our ID numbers
require(ggplot2)
require(ggthemes)
require(extrafont)
require(booktabs)
require(GGally)
require(ggExtra)
require(xtable)
require(moments)
require(ggcorrplot)
require(fitdistrplus)
require(reshape2)
#require(farff)
```

# Exploratory Data Analysis of our overall data

# Univariate

We (group 10) decided to use the Dating App User Profiles' stats data set. The data set is available on kaggle (@Lovoov3) and the license to use the data set is available on creativecommons (@License). We decided to explore the variables age, counts_pictures, counts_profileVisits, counts_kisses, distance, country and isVip.

**Age** is the users age, **counts_pictures** is the number of pictures on the user's profile, **counts_profileVisits** is the number of clicks on this user (to see his/her full profile) from other user accounts, **counts_kisses** is the number of unique user accounts that "liked" (called "kiss" on the platform) this user account, **distance** is the distance between this user's city/location and the location of the user account that was used to fetch the data of this user, **country** is the user's country, **isVip** is a 1 if the user is VIP. [It was possible to buy a VIP status with real money. This status came with benefits.].

It was discovered that there were 46 missing values in the variable distance. These have been replaced by the mean of the distance column (207.23). After replacing the 46 missing distance variables to ensure we have a full data set, we have a sample size of 3992 for all seven variables. 

The ages of the user's of the lovoo app range from 18 years to 28 years with the median age being 22 year. The minimum number of pictures on a user's profile is 0 with the maximum being 30 pictures and the median being 4.The number of clicks on a user's profile to see his/her full profile (from another users account) ranges from 0 to 164425 clicks, with the median being 1222 clicks. The number of unique user accounts that "liked" a users account ranges from 0 to 9288 likes, with the median being 44 likes. The distance between this user's city/location and the location of the user account that was used to fetch the data of the user ranges from 0 to 6918, with the median being 173. These and other summary statistics can be seen in table \@ref(SumStat). 

As identified in the summary statistics the median age is 22 and this is supported by the boxplot in figure \@ref(fig:ageplot). We can also see that the mean age is equal to 22 also. The green line shows the estimated normal density for the age. The age of the users appears to be normally distributed. The blue line shows the smoothed density histogram for age, this appears to go down between each value of age. This is likely to the fact that age has been measured discretely and the smoothed histogram is continuous. 
*We are unsure as to why we are getting a warning message for figure \@ref(fig:ageplot) as there is no missing data for age.*

The bulk of users tend to have less than 10 profile pictures on their account. We can see from the boxplot in figure \@ref(fig:picturesplot) that there are a number of users that have a higher number of profile pictures on their account. This is also visible in the histogram which shows a long tail to the right.

The original graph for the number of profile visits a user has is very hard to read, so figure \@ref(fig:visitsplot) shows the squre root transformed data. This is still hard to read due to an extreme outlier (+100,000 visits counted). We removed the extreme outlier in order to better read the graph. We can see in figure \@ref(fig:visitsplot2) that mean is much closer to the 75% percentile than it is the median. User's tend to have between 0 and 4000 profile visits, however, about 25% of user's have a much higher number of visits and this is skewing the data.

The number of 'kisses' a user receives appears to be heavily skewed to the right. There are a large number of outliers or large values.The mean appears to be larger than the 75% percentile as seen in figure \@ref(fig:kisssplot).

There are 32 different countries that users come from. The summary of the countries and their counts can be found in table \@ref(Countryfreq) and a visualisation can be seen in figure \@ref(fig:barcountry). Table \@ref(vipfreq) shows that 3901 users are not Vip's while only 91 are Vip's and figure \@ref(fig:purchasedVip) shows a visualisation.

```{r, echo=FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", 
                   "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Replacing country codes with full names
lovoo["country"][lovoo["country"] == 'AR'] <- 'Argentina'
lovoo["country"][lovoo["country"] == 'AT'] <- 'Austria'
lovoo["country"][lovoo["country"] == 'AU'] <- 'Australia'
lovoo["country"][lovoo["country"] == 'BA'] <- 'Bosnia and Herzegovina'
lovoo["country"][lovoo["country"] == 'BE'] <- 'Belgium'
lovoo["country"][lovoo["country"] == 'BR'] <- 'Brazil'
lovoo["country"][lovoo["country"] == 'CA'] <- 'Canada'
lovoo["country"][lovoo["country"] == 'CF'] <- 'Central African Republic'
lovoo["country"][lovoo["country"] == 'CH'] <- 'Switzerland'
lovoo["country"][lovoo["country"] == 'CZ'] <- 'Czechia'
lovoo["country"][lovoo["country"] == 'DE'] <- 'Germany'
lovoo["country"][lovoo["country"] == 'ES'] <- 'Spain'
lovoo["country"][lovoo["country"] == 'ET'] <- 'Ethiopia'
lovoo["country"][lovoo["country"] == 'FR'] <- 'France'
lovoo["country"][lovoo["country"] == 'GB'] <- 'United Kingdom of Great Britain and Northern Ireland'
lovoo["country"][lovoo["country"] == 'HU'] <- 'Hungary'
lovoo["country"][lovoo["country"] == 'ID'] <- 'Indonesia'
lovoo["country"][lovoo["country"] == 'IN'] <- 'India'
lovoo["country"][lovoo["country"] == 'IT'] <- 'Italy'
lovoo["country"][lovoo["country"] == 'JM'] <- 'Jamaica'
lovoo["country"][lovoo["country"] == 'LI'] <- 'Liechtenstein'
lovoo["country"][lovoo["country"] == 'LR'] <- 'Liberia'
lovoo["country"][lovoo["country"] == 'LU'] <- 'Luxembourg'
lovoo["country"][lovoo["country"] == 'NL'] <- 'Netherlands'
lovoo["country"][lovoo["country"] == 'PE'] <- 'Peru'
lovoo["country"][lovoo["country"] == 'PH'] <- 'Philippines'
lovoo["country"][lovoo["country"] == 'RO'] <- 'Romania'
lovoo["country"][lovoo["country"] == 'RU'] <- 'Russian Federation'
lovoo["country"][lovoo["country"] == 'SC'] <- 'Seychelles'
lovoo["country"][lovoo["country"] == 'TR'] <- 'Turkey'
lovoo["country"][lovoo["country"] == 'UA'] <- 'Ukraine'
lovoo["country"][lovoo["country"] == 'US'] <- 'United States of America'

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)
```

```{r, echo=FALSE}
# creating summary statistics
MySummary <- function(df){
  (c(length(df), min(df), quantile(df, .25), median(df), quantile(df, .75),
     max(df), IQR(df), sd(df), mean(df)))
}
```

```{r results = 'asis', echo=FALSE}
SumStat <- apply(lovoo[,1:5], MySummary, MARGIN=2)
rownames(SumStat) <- c("sample size", "minimum", "first quartile", "median",
                       "third quartile", "maximum", "IQR", 
                       "standard deviation", "mean")

print(xtable(SumStat, caption="Summary Statistics - Numerical Variables", 
             label="SumStat"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r ageplot, fig.cap="Age", echo=FALSE}
ageplot <- ggplot(lovoo, aes(x=age)) +
  geom_histogram(aes(y=..density..),
                 binwidth = 1,
                 col='black', fill='white') +
  scale_x_continuous(breaks = seq(17,29,1), lim = c(17,29)) +
  labs(x = 'Age',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Visualisation of the user's age") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$age), 
                                         sd = sd(lovoo$age)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$age), col="red", size=1) +
  theme_tufte()

ageplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r picturesplot, fig.cap="Profile pictures", echo=FALSE}
picsplot <- ggplot(lovoo, aes(x=counts_pictures)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$counts_pictures)),
                 col='black', fill='white') +
  labs(x = 'Number of Profile Pictures',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Visualisation of the number of profile pictures a user has") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$counts_pictures), 
                                         sd = sd(lovoo$counts_pictures)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$counts_pictures), col="red", size=1) +
  theme_tufte()

picsplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r visitsplot, fig.cap="Square-root transformed Profile visits", echo=FALSE}
visitsplot <- ggplot(lovoo, aes(x=counts_profileVisits)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$counts_profileVisits)),
                 col='black', fill='white') +
  labs(x = 'Number of Profile Visits',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Visualisation of the squre-root transformed number of profile visits") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.01), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$counts_profileVisits), 
                                         sd = sd(lovoo$counts_profileVisits)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$counts_profileVisits), col="red", size=1) +
  theme_tufte() +
  scale_x_continuous(trans = 'sqrt')

visitsplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r visitsplot2, fig.cap="Square-root transformed Profile visits - minus the outlier", echo=FALSE, warning=FALSE}
dating_r<-lovoo$counts_profileVisits
dating_removed<-dating_r[dating_r<100000]

mz <- mean(dating_removed)
sdz <- sd(dating_removed)

dating_removed_df<-as.data.frame(dating_removed)

ggplot(dating_removed_df, aes(x=dating_removed)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$counts_profileVisits)),
                 col="black", fill="white") +
  xlab("Number of profile Visits") +
  ylab("Histogram, smoothed histogram, and estimated normal density") +
  ggtitle("Visualisation of the squre-root transformed Profile Visits (minus outlier)")+
  geom_density(col='blue', size=1.5) +
  stat_function(fun = "dnorm", args=list(mean=mz, sd=sdz), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mz, col="red", size=1) +
  geom_boxplot(aes(y=-.02), width=.01, notch = TRUE, col='blue')+
  theme_tufte() + scale_x_continuous(trans = 'sqrt')
```

```{r kisssplot, fig.cap="Profile Likes", echo=FALSE}
kissplot <- ggplot(lovoo, aes(x=counts_kisses)) +
  geom_histogram(aes(y=(..density..)^0.5),
                 bins=nclass.FD(unlist(lovoo$counts_kisses)),
                 col='black', fill='white') +
  labs(x = 'Number of Profile kisses',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Number of Likes a user's profile has") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$counts_kisses), 
                                         sd = sd(lovoo$counts_kisses)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$counts_kisses), col="red", size=1) +
  theme_tufte() +
  scale_x_continuous(trans = 'sqrt')

kissplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r distplot, fig.cap="Distance", echo=FALSE}
distplot <- ggplot(lovoo, aes(x=distance)) +
  geom_histogram(aes(y=..density..),
                 bins=nclass.FD(unlist(lovoo$distance)),
                 col='black', fill='white') +
  labs(x = 'Distance',
       y = 'Histogram, smoothed histogram, and estimated normal density')+
  ggtitle("Distance between user's") +
  theme(plot.title = element_text(hjust = 0.5)) +
  geom_density(col='blue', size=1.5) +
  geom_boxplot(aes(y=-0.02), width = .01, notch=TRUE, col='blue') +
  stat_function(fun = dnorm, args = list(mean = mean(lovoo$distance), 
                                         sd = sd(lovoo$distance)), 
                col='darkgreen', size=1.5) +
  geom_vline(xintercept = mean(lovoo$distance), col="red", size=1) +
  theme_tufte() +
  scale_x_continuous(trans = 'sqrt')

distplot + theme(text=element_text(size=12, 
        family="serif")) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r results = 'asis', echo=FALSE}
vip_freq <- table(lovoo$isVip)
vip_freq <- data.frame(vip_freq)
colnames(vip_freq) <- c("isVip", "Count")
rownames(vip_freq) <- c("No", "Yes")
print(xtable(vip_freq, caption="Summary Statistics - isVip", label="vipfreq"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r purchasedVip, fig.cap='Count of whether a user is a VIP (nor not)', echo=FALSE}
barplot(table(lovoo$isVip), col = "blue", main = "Purchased Vip", xlab = "Purchased", ylab = "Count", ylim = c(1, 4000))
```

```{r results = 'asis', echo=FALSE}
coun_freq <- table(lovoo$country)
coun_freq <- data.frame(coun_freq)
colnames(coun_freq) <- c("Country", "Count")
print(xtable(coun_freq, caption="Summary Statistics - Countires", label="Countryfreq"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r barcountry, fig.cap="Number of user's by Country", echo=FALSE}
countrybar <- ggplot(lovoo, aes(x=country)) +
  geom_bar(fill='blue') +
  ggtitle("Count of user's by country") +
  theme_tufte()

countrybar + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

After the initial analysis of our variables we noticed that four of the countries (Switzerland (CH), Germany (DE), France
(FR) and Italy (IT)) have significantly larger number of users compared to the other 28 countries. The other countries have between 1 and 20 users, we decided that we would group all other countries into one category called 'other' and explore the data further. Even with grouping the 28 countries they still have the lowest number of users out of the five new groups. The 'other' group has 83 users as seen in table \@ref(Countryfreq2). A visualisation of the users by country can be seen in figure \@ref(fig:barcountry2).

```{r, echo=FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Replacing variable names
lovoo["country"][lovoo["country"] == 'CH'] <- 'Switzerland'
lovoo["country"][lovoo["country"] == 'DE'] <- 'Germany'
lovoo["country"][lovoo["country"] == 'FR'] <- 'France'
lovoo["country"][lovoo["country"] == 'IT'] <- 'Italy'
lovoo["country"][lovoo["country"] == 'AR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AT'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CF'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CZ'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ES'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ET'] <- 'Other'
lovoo["country"][lovoo["country"] == 'GB'] <- 'Other'
lovoo["country"][lovoo["country"] == 'HU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ID'] <- 'Other'
lovoo["country"][lovoo["country"] == 'IN'] <- 'Other'
lovoo["country"][lovoo["country"] == 'JM'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LI'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'NL'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PH'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RO'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'SC'] <- 'Other'
lovoo["country"][lovoo["country"] == 'TR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'UA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'US'] <- 'Other'

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)
```

```{r results = 'asis', echo=FALSE}
coun_freq <- table(lovoo$country)
coun_freq <- data.frame(coun_freq)
colnames(coun_freq) <- c("Country", "Count")
print(xtable(coun_freq, caption="Summary Statistics - with grouped countries", label="Countryfreq2"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r barcountry2, fig.cap="Number of user's by Country", echo=FALSE}
countrybar2 <- ggplot(lovoo, aes(x=country)) +
  geom_bar(fill='blue') +
  ggtitle("Count of user's by country") +
  theme_tufte()

countrybar2 + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

# Bivariate and Multivariate

There appears to be strong positive correlation between the number of profiles visits and the number of likes that a user receives. There is also positive correlation between the number of pictures a user has and the number of profile visits they receive, as well as the number of likes the user has. There is slight positive correlation between the age of the user and the distance between this user's city/location and the location of the user account that was used to fetch the data of the user. There appears to be no correlation between age and likes, profile visits and pictures, nor distance and likes, profile visits and pictures. This can been seen in figure \@ref(fig:correlationmatrix) and numerically in table \@ref(correlationmatrixnum), and supported by the pairs plots in figure \@ref(fig:pairsplot).

Earlier we saw that there was significantly more non-Vip user's than Vip users (table \@ref(vipfreq)). In  shows that 3901 users are not Vip's while only 91 are Vip's. We can see in table \@ref(vipcountry) that Switzerland has the most Vip's, this is supported in figure \@ref(fig:barvipcountry).

We see that there is a high correlation (0.89) between profile visits and profile likes (table \@ref(correlationmatrixnum)). We see from figure \@ref(fig:scatterplot) that there is a positive relationship between profile visits and profile likes. We can also see there are several outliers that we should remove as they can be very influential to our data. After removing the outliers from figure \@ref(fig:scatterplot) we see the same positive relationship but the outlieing profiles are gone (figure \@ref(fig:scatterplot2)).

We see that the number of users by age tends to increase in Germany and peak at 22 years old before decreasing. Where as in France and Switzerland they tend to start with a larger number of users at younger age and decrease as age increases. This can be seen in figure \@ref(fig:agecount).

```{r correlationmatrix, fig.cap="Correlation Matrix", echo=FALSE, warning=FALSE}
ggcorrplot(cor(lovoo[,1:5]),
           method = "circle",
           hc.order = TRUE,
           type = "lower") +
  ggtitle("Correlation Matrix") 
```

```{r results = 'asis', echo=FALSE, warning=FALSE}
c <- cor(lovoo[,1:5])

print(xtable(c, caption="Correlation matrix", label="correlationmatrixnum"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r pairsplot, fig.cap='Pairs plot', echo=FALSE}
ggpairs(lovoo[,1:5]) +
  ggtitle("Pairs plots of age, pictures, profile visits, likes and distance") +
  theme(plot.title=element_text(hjust=0.5)) 
```

```{r results = 'asis', echo=FALSE}
newtab <- table(lovoo$country, lovoo$isVip)
colnames(newtab) <- c("isVip - No", "isVip - Yes")
print(xtable(newtab, caption="Summary Statistics - isVip (or not) by country", label="vipcountry"), comment=FALSE,
            caption.placement="top", type="latex")
```
# Reference isn't working!

```{r barvipcountry, fig.cap='Count of users by country and Vip status ', echo=FALSE}
ggplot(lovoo) +
  geom_bar(aes(x = country, fill = isVip)) +
  ggtitle("Count of users by country and Vip status") +
  theme_tufte() +
  theme(plot.title=element_text(hjust=0.5))
```
#fix size of plot! Reference isn't working
```{r agecount, fig.cap='Number of users by age and country' ,echo=FALSE}
ggplot(lovoo, aes(x=country)) +
  geom_bar(aes(fill=country)) + 
  ylab(label='Number of users') + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  facet_grid(~age)
```

```{r, echo=FALSE}
lovoo2 <- lovoo[, c("counts_profileVisits", "counts_kisses", "isVip")]
```

```{r scatterplot, fig.cap='Scatterplot of profile visits vs profile likes', echo=FALSE}
plot(lovoo2$counts_profileVisits, lovoo2$counts_kisses, main="Profile visits against Profile likes",
   xlab="Profile Visits", ylab="Profile Likes")
abline(lm(lovoo2$counts_kisses ~ lovoo2$counts_profileVisits, data = lovoo2), col = "red")
```

```{r , echo=FALSE}
Q1visits <- quantile(lovoo2$counts_profileVisits, .25)
Q3visits <- quantile(lovoo2$counts_profileVisits, .75)

Q1likes <- quantile(lovoo2$counts_kisses, .25)
Q3likes <- quantile(lovoo2$counts_kisses, .75)

IQRvisits <- IQR(lovoo2$counts_profileVisits)
IQRlikes <- IQR(lovoo2$counts_kisses)

lovoo2 <- subset(lovoo2, lovoo2$counts_profileVisits > (Q1visits - 1.5*IQRvisits) & lovoo2$counts_profileVisits < (Q3visits + 1.5*IQRvisits))
lovoo2 <- subset(lovoo2, lovoo2$counts_kisses > (Q1likes - 1.5*IQRlikes) & lovoo2$counts_kisses < (Q3likes + 1.5*IQRlikes))
```

```{r scatterplot2, fig.cap='Revised scatterplot of profile visits vs profile likes', echo=FALSE}
plot(lovoo2$counts_profileVisits, lovoo2$counts_kisses, main="Revised - Profile visits against Profile likes",
   xlab="Profile Visits", ylab="Profile Likes")
abline(lm(lovoo2$counts_kisses ~ lovoo2$counts_profileVisits, data = lovoo2), col = "red", lwd=2)
```

# Burning questions

# Profile Visits, Like, Country and Vip

After our initial analysis we know that profile visits and profile likes are highly correlated. We want to know if the number of profile visits and likes varies from country. We are also interested to know if having Vip status in each country affects the number of profile visits and likes.

There appears to be a positive correlation between the number of profile pictures a user has and the number of profile visits they receive, as well as the number of likes the profile receives. It appears that having Vip status has a higher correlation in these cases. The number of likes on a profile and the number of profile visits is strongly positively correlated, this is only slightly higher in Vip's compared to non-Vip's as seen in figure \@ref(fig:pairsplotvip). The correlation between countries for these variables varies a little. The biggest thing to note is that Italy appears to have a correlation of 0.947 between the number of likes a user has and the number of visits (figure \@ref(fig:pairsplotcountry)).

The boxplot of the number of profile visits and likes by country is very hard to read (figure \@ref(fig:boxlikeviscountry)), we have transformed this by taking the log of profile likes. We can see from th revised boxplot (figure \@ref(fig:boxlikeviscountry)) that Germany has the largest range of profile visits while France has the least. France, Germany and Italy have very similar ranges of the number of profile likes. Our group of 'other' countries appears to have the largest median for the number of profile likes. We can conclude that there is a difference in the number of profile visits and the number of profile likes for each country.

Looking at figure \@ref(fig:boxlikeviscountryvip) we can see that having Vip status tends to improve the number of profile likes a user receives in our four main countries. However this is not the case in the 'other' countries as only 1 person from 'other' has Vip status. The biggest difference can be seen in Germany.

To conclude if you live in Germany and you want more profile likes then you should like to purchase Vip status.

```{r, echo=FALSE}
# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Replacing variable names
lovoo["country"][lovoo["country"] == 'CH'] <- 'Switzerland'
lovoo["country"][lovoo["country"] == 'DE'] <- 'Germany'
lovoo["country"][lovoo["country"] == 'FR'] <- 'France'
lovoo["country"][lovoo["country"] == 'IT'] <- 'Italy'
lovoo["country"][lovoo["country"] == 'AR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AT'] <- 'Other'
lovoo["country"][lovoo["country"] == 'AU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'BR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CF'] <- 'Other'
lovoo["country"][lovoo["country"] == 'CZ'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ES'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ET'] <- 'Other'
lovoo["country"][lovoo["country"] == 'GB'] <- 'Other'
lovoo["country"][lovoo["country"] == 'HU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'ID'] <- 'Other'
lovoo["country"][lovoo["country"] == 'IN'] <- 'Other'
lovoo["country"][lovoo["country"] == 'JM'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LI'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'LU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'NL'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PE'] <- 'Other'
lovoo["country"][lovoo["country"] == 'PH'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RO'] <- 'Other'
lovoo["country"][lovoo["country"] == 'RU'] <- 'Other'
lovoo["country"][lovoo["country"] == 'SC'] <- 'Other'
lovoo["country"][lovoo["country"] == 'TR'] <- 'Other'
lovoo["country"][lovoo["country"] == 'UA'] <- 'Other'
lovoo["country"][lovoo["country"] == 'US'] <- 'Other'
unique(lovoo$country) 

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)
```

```{r pairsplotvip, fig.cap="Pairs plot by isVip",warning = FALSE, echo=FALSE}
ggpairs(lovoo[,1:5],
ggplot2::aes(col=lovoo$isVip, alpha=.5)) +
ggplot2::scale_color_manual(values=c("green", "blue")) +
ggplot2::theme(axis.text.x = element_text(angle=90, hjust=1))
```


## Need to fix this plot!!!!!!!!!!!!!!!!!
```{r pairsplotcountry, fig.cap="Pairs plot by country",warning = FALSE, echo=FALSE}
ggpairs(lovoo[,1:5],
ggplot2::aes(col=lovoo$country, alpha=.5)) +
ggplot2::scale_color_manual(values=c("lightgray", "green", "blue", "red", "orange")) +
ggplot2::theme(axis.text.x = element_text(angle=90, hjust=1))
```

```{r boxlikeviscountry, fig.cap='Boxplot of profile visits and likes by country', echo=FALSE}
ggplot(lovoo, aes(x=counts_profileVisits, y=counts_kisses)) +
  geom_boxplot(aes(col=country), notch=TRUE) +
  xlab('Number of Profile Visits') + 
  ylab('Number of Profile Likes') +
  ggtitle("Profile Visits vs Profile Likes") +
  facet_grid(~ country) +
  theme(axis.text.x = element_text(size=7, angle=90, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r boxlikeviscountry2, fig.cap='Revised boxplot of profile visits and likes by country', echo=FALSE}
ggplot(lovoo, aes(x=counts_profileVisits, y=log(counts_kisses))) +
  geom_boxplot(aes(col=country), notch=TRUE) +
  xlab('Number of Profile Visits') + 
  ylab('Number of Profile Likes') +
  ggtitle("Profile Visits vs Log Profile Likes") +
  facet_grid(~ country) +
  theme(axis.text.x = element_text(size=7, angle=90, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r boxlikeviscountryvip, fig.cap='Revised boxplot of profile visits and likes by country and vip', echo=FALSE}
ggplot(lovoo, aes(x=counts_profileVisits, y=log(counts_kisses))) +
  geom_boxplot(aes(col=country), notch=TRUE) +
  xlab('Number of Profile Visits') + 
  ylab('Number of Profile Likes') +
  ggtitle("Profile Visits, Log Profile Likes for each country and Vip") +
  facet_grid(~ isVip) +
  theme(axis.text.x = element_text(size=7, angle=90, hjust=1)) +
  theme(plot.title=element_text(hjust=0.5))
```


























# Counts_profileVisits, counts_kisses and isVip

How does profile visits affect profile likes?

We see that there is a high correlation (0.89) between profile visits and profile likes (figure \@ref(fig:cormat)). We see from figure \@ref(fig:scatterplot) that there is a positive relationship between profile visits and profile likes. We can also see there are several outliers that we should remove as they can be very influential to our data. After removing the outliers from figure \@ref(fig:scatterplot) we see the same positive relationship but the outlieing profiles are gone (figure \@ref(fig:scatterplot2)).

Does having "VIP" mean you get more profile visits and likes?

The distribution of profile visits and profile likes is right skewed and definitely does not follow a normal distribution as seen in figure \@ref(fig:freqvisitlikes). The density graphs (figure \@ref(fig:desnitylikes)) for both profile visits and profile likes is right skewed. This means that for both profile likes and visits, the mean is greater than the median. The mean of the boxplot for profiles with "VIP" is less than the mean of the boxplot for profiles without "VIP", this means on average profiles with "VIP" get less profile visits and likes than profiles without "VIP" as shown in figure \@ref(fig:boxplotvipvisitlikes)

```{r, echo=FALSE}
lovoo <- lovoo[, c("counts_profileVisits", "counts_kisses", "isVip")]
```

```{r cormat, fig.cap='Correlation of profile visits and kisses', echo=FALSE}
cormat <- round(cor(lovoo[, c("counts_profileVisits", "counts_kisses")]),2)
#head(cormat)
melted_cormat <- melt(cormat)
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()
```




```{r desnitylikes, fig.cap='Density of Profile Likes based on VIP status', echo=FALSE}
par(mfrow=c(1,2))
ggplot(lovoo, aes(x=counts_profileVisits, color=isVip)) + 
  geom_density() + labs(x="Profile Visits") + labs(color="VIP") + scale_color_discrete(labels=c('Yes', 'No'))
ggplot(lovoo, aes(x=counts_kisses, color=isVip)) + 
  geom_density() + labs(x="Profile Likes") + labs(color="VIP") + scale_color_discrete(labels=c('Yes', 'No')) + geom_vline(data=lovoo, aes(xintercept=mean(counts_kisses), color=isVip),
             linetype="dashed")
```

```{r boxplotvipvisitlikes, fig.cap='side by side boxplots of Profile Visits and Profile Likes against VIP status',  echo=FALSE}
par(mfrow=c(1,2))
boxplot(lovoo$isVip, lovoo$counts_profileVisits, names=c("Yes", "No"), main="Profie Visits by profiles with 'VIP'", ylab="Profile Visits")
boxplot(lovoo$isVip, lovoo$counts_kisses, names=c("Yes", "No"), main="Profie Likes by profiles with 'VIP'", ylab="Profile Likes")
```

# Country, isVip and Distance

Looking at the variables - country, isVIp and distance individually. It can be observed that the greatest number of users come from: Switzerland (CH), Germany (DE), France (FR) and Italy (IT) (figure \@ref(fig:freqcountry). From figure \@ref(fig:purchasedVip) we can see that the majority of users haven't purchased VIP status. It can be observed that the distance data is left skewed. The majority of distance between this user's city/location and the location of the user account that was used to fetch the data is higher than the median (figures \@ref(fig:histdistance) and \@ref(fig:histdistance2)).

\@ref(fig:boxplotdistvip) shows that the median of Vip and non-Vip are approximately equal, however the distance of the not a Vip's is much larger than that of the Vip's which is to be expected given that a there is a larger number of non-Vip's compared to Vip's. This can also be seen in \@ref(vipcountry).

\@ref(fig:countcountryvip) shows it can be observed from this graph that Switzerland (CH), Germany (DE), France (FR) and Italy (IT) have the greatest number of users who have purchased VIP status.

```{r, echo=FALSE}
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)

new_dataset <- lovoo[, c("distance", "country", "isVip")]
```



```{r boxplotdistvip, fig.cap='Boxplot of distance and isVip', echo=FALSE, warning=FALSE}
ggplot(new_dataset) +
  geom_boxplot(aes(x = distance, y = isVip)) + coord_flip()
```





# Counts_pictures, counts_profiles and counts_kisses

From table \@ref(SumStat) we can see that the number of pictures a user profile has, has a heavy right tail, showing most women have about 4 photos attached to their accounts and the maximum the can choose to have is 30. All values are positive. Profile visits is slightly more symmetric than the pictures distribution but still has a heavy skew with some extreme values and large range. This variable would benefit from the analysis of distances. All values are positive. The number of kisses (likes) has a heavy right tail with large range. But all values are positive.

Figure \@ref(fig:histPics) shows the Square-root transformed (for readability) distribution of counts_pictures. As we can see, is it pretty normal to have between 0 & 12 photos as this is where the boxplot spans. It is heavily centered around the lower end of the count.
Figure \@ref(fig:histVisits) shows the Square-root transformed distribution of counts_profileVisits. There has been an extreme value (100,000 visits counted) removed as it made the graph unreadable. It is heavily centered around the lower end of the count.
Figure \@ref(fig:histKiss) shows the Square-root transformed distribution of counts_kisses. It is heavily centered around the lower end of the count.

The variance and covariance matrices can be seen in tables (\@ref(varkatrina) and \@ref(corkatrina)). All variables are positively related

All variables are positively correlated, this is what we expect as with more visits there will be more likes and so on. Figure \@ref(fig:corVisCount) shows that there is a correlation of interest between profile visits and kisses. 

Looking at Mahalanobis distance we can see there are some very surprising values (108) from the table and Figure \@ref(fig:maha), it could be worth while examining these and possibly removing them as outliers. These might be famous people that receive a lot of attention online or other cases that are not simply a single woman looking for love online. 

Figure \@ref(fig:pairsCount) further shows where the very surprising values are - they are mainly on the fringes of the data. although in the univariate distributions we can see that most very suprising values do make up the lower end of the photos which is what we would assume was normal. 
There will have to be more discussion around the exclusion of points from the data. 

*The contour plots are giving a warning message, I think due to scale*

All contour plots (Figure \@ref(fig:contourPFP), Figure \@ref(fig:contourKP), Figure \@ref(fig:contourKPF)) are centered around zero and spread with a positive relationship to each other. 


```{r, echo=FALSE}
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo)
```

```{r, echo=FALSE}
dating <-lovoo[,c("counts_pictures", "counts_profileVisits", "counts_kisses")]
#head(dating) # subsetted the info I would be working with 
```







```{r maha, fig.cap="Mahalanobis distince plotted", echo=FALSE, warning=FALSE}
mu.hat <- colMeans(dating)
Sigma.hat <- cov(dating)
dM <- mahalanobis(dating, center=mu.hat, cov=Sigma.hat)
upper.quantiles <- qchisq(c(.9, .95, .99), df=9)
density.at.quantiles <- dchisq(x=upper.quantiles, df=9)
cut.points <- data.frame(upper.quantiles, density.at.quantiles)
ggplot(data.frame(dM), aes(x=dM)) +
geom_histogram(aes(y=..density..), bins=nclass.FD(dM),
fill="white", col="black") +
geom_rug() +
stat_function(fun="dchisq", args = list(df=9),
col="red", size=2, alpha=.7, xlim=c(0,25)) +
geom_segment(data=cut.points, aes(x=upper.quantiles, xend=upper.quantiles,
y=rep(0,3), yend=density.at.quantiles),
col="blue", size=2) +
xlab("Mahalanobis distances and cut points") +
ylab("Histogram and density")+ scale_x_continuous(trans = 'sqrt')

```

```{r results = 'asis', echo=FALSE, warning=FALSE}
dating$dM <- dM
dating$surprise <- cut(dating$dM,
breaks= c(0, upper.quantiles, Inf),
labels=c("Typical", "Somewhat", "Surprising", "Very"))
d <- table(dating$surprise)
print(xtable(d, caption="Surprising table", label="surprise"), comment=FALSE,
            caption.placement="top", type="latex")
```

```{r pairsCount, fig.cap="Pairs plot of count pictures, profile visits, and kisses",warning = FALSE, echo=FALSE}
ggpairs(dating, columns=1:3,
ggplot2::aes(col=surprise, alpha=.5), upper = list(continuous = "density", combo = "box_no_facet")) +
ggplot2::scale_color_manual(values=c("lightgray", "green", "blue", "red")) +
ggplot2::theme(axis.text.x = element_text(angle=90, hjust=1))

```

```{r contourPFP, fig.cap="Contour plot of count profile visits and pictures", echo=FALSE, warning=FALSE}
ggplot(dating, aes(y=dating[,1], x=dating[,2])) +
geom_density_2d(col="blue") + xlab("Count of profile visits") + ylab("Count of pictures") + 
  ggtitle("Contour plot of count profile visits and pictures")
```

```{r contourKP, fig.cap="Contour plot of count kisses and pictures", echo=FALSE, warning=FALSE}
ggplot(dating, aes(y=dating[,1], x=dating[,3])) +
geom_density_2d(col="blue") + xlab("Count of kisses") + ylab("Count of pictures") + 
  ggtitle("Contour plot of count kisses and pictures")
```

```{r contourKPF, fig.cap="Contour plot of count profile visits and kisses", echo=FALSE, warning=FALSE}
ggplot(dating, aes(y=dating[,2], x=dating[,3])) +
geom_density_2d(col="blue") + xlab("Count of kisses") + ylab("Count of profile visits") + 
  ggtitle("Contour plot of count profile visits and kisses")
```

# Age, country and number of pictures

Figure \@ref(fig:agecount2) shows the number of users by age. The number of users is heavier in the age range 19-22 (inclusive). It appears that a large number of countries have a very small number of users, while a few countries such as Switzerland, Germany, France and Italy have larger numbers of users. This can be seen in \@ref(fig:freqcountry). Table \@ref(counage) shows us a breakdown of the number of users per country by age. Again this supports higher numbers in Switzerland, Germany, France and Italy. Taking a closer look at the countries - Switzerland, Germany, France and Italy we can look at the number of users per country by age. Figure \@ref(fig:agecount) shows that Switzerland has the larger number of users with ages 19-21 and Germany has the larger number of users for ages 22-24. Looking at the boxplot in figure \@ref(fig:boxplotdistance) we can see that there are a few very large outliers in the data and it is very hard to read the boxplots. By taking the log of the data we can see the median more clearly. Figure \@ref(fig:boxplotdistance2) shows that the medians vary, however there is not much variability within a country across the different ages. 

```{r}
plots <- vector('list', length(c(0,1)))

library(dplyr)

for (x in c(0,1)) {
  dating <- lovoo[c("counts_pictures", "counts_profileVisits", "counts_kisses", "country")]
  #dating<-subset(dating, country==x)
  pvals_v <- vector('list', nrow(dating))
  for (i in 1:nrow(dating)) {
    x.new <- dating[i,-4]
    dating <- dating %>%  filter(!row_number() %in% c(i))
    est.mu <- colMeans(dating[, -4])
    est.covar <- var(dating[, -4])
  
    d.new <- mahalanobis(x.new, center = est.mu, cov = est.covar)
    pvals_v[[i]] = pchisq(d.new, df = 3, lower.tail = FALSE)
  }
  df<-data.frame(val = unlist(pvals_v)) 
  plots[[x+1]] = ggplot(df, aes(val)) +   geom_histogram(bins=10) + theme_bw() +
  geom_vline(xintercept = 0.05, col="red") 
}
ggarrange(plotlist=plots,ncol = 2, nrow = 1)
dating
```

```{r, echo=FALSE}

# Reading in the data
lovoo <- read.csv("../../Data/CSV/lovoo_v3_users_api-results.csv")

# Converting data to a data frame
lovoo <- data.frame(lovoo) 

# Selecting the columns that contain our variables
lovoo <- lovoo[, c("age", "counts_pictures", "counts_profileVisits", "counts_kisses", "distance", "country", "isVip")]

# Replacing the missing values in distance with the mean 207.23
lovoo$distance[is.na(lovoo$distance)] <- 207.23

# Setting country and isVip to be factors.
lovoo$country <- as.factor(lovoo$country)
lovoo$isVip <- as.factor(lovoo$isVip)
```

```{r agecount2, fig.cap='Number of users by age' ,echo=FALSE}
ggplot(lovoo, aes(x=age)) +
  geom_bar(fill='blue') + 
  ylab(label='Number of users')
```

```{r results = 'asis', echo=FALSE}
coun_age <- table(lovoo$country, lovoo$age)
print(xtable(coun_age, caption="Country vs age", label="counage"), comment=FALSE,
            caption.placement="top", type="latex")
```





```{r boxplotdistance2, fig.cap='Side by side boxplots of age, country and distance (log scale)', echo=FALSE}
ggplot(lovoo.high.country, aes(x=(country), y=distance)) +
  geom_boxplot(aes(fill=country), notch=TRUE) +
  scale_y_log10() +
  ylab(label='Distance') +
  facet_grid(~ age)
```























# References

